name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type for this release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: read
  pull-requests: write

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          # Get latest tag
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          version="${latest_tag#v}"

          IFS='.' read -r major minor patch <<< "$version"

          case "${{ inputs.version_bump }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          new_version="v${major}.${minor}.${patch}"
          echo "current=$latest_tag" >> $GITHUB_OUTPUT
          echo "next=$new_version" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          latest="${{ steps.version.outputs.current }}"
          next="${{ steps.version.outputs.next }}"

          echo "## What's Changed in $next" > pr_body.md
          echo "" >> pr_body.md

          # Get commits between production and main
          commits=$(git log origin/production..origin/main --pretty=format:"- %s (%h)" 2>/dev/null || echo "")

          if [ -n "$commits" ]; then
            echo "$commits" >> pr_body.md
          else
            echo "- No changes" >> pr_body.md
          fi

          echo "" >> pr_body.md
          echo "---" >> pr_body.md
          echo "" >> pr_body.md
          echo "**Previous version:** $latest" >> pr_body.md
          echo "**New version:** $next" >> pr_body.md

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          next="${{ steps.version.outputs.next }}"

          # Check if PR already exists
          existing_pr=$(gh pr list --base production --head main --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$existing_pr" ]; then
            echo "PR #$existing_pr already exists for main -> production"
            echo "## Existing PR Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "PR #$existing_pr already exists: https://github.com/${{ github.repository }}/pull/$existing_pr" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Create the PR
          pr_url=$(gh pr create \
            --base production \
            --head main \
            --title "Release $next" \
            --body-file pr_body.md)

          echo "## Release PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $next" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** $pr_url" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Merge this PR to trigger the release workflow which will:" >> $GITHUB_STEP_SUMMARY
          echo "- Create a GitHub release with tag $next" >> $GITHUB_STEP_SUMMARY
          echo "- Generate changelog" >> $GITHUB_STEP_SUMMARY
          echo "- Sync main branch with production" >> $GITHUB_STEP_SUMMARY
