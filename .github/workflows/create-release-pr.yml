name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type for this release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: read
  pull-requests: write

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          # Get latest tag
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          version="${latest_tag#v}"

          IFS='.' read -r major minor patch <<< "$version"

          case "${{ inputs.version_bump }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          new_version="v${major}.${minor}.${patch}"
          echo "current=$latest_tag" >> $GITHUB_OUTPUT
          echo "next=$new_version" >> $GITHUB_OUTPUT

      - name: Check for existing PR
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          existing=$(gh pr list --base production --head main --json number --jq '.[0].number // empty')
          if [ -n "$existing" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "number=$existing" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_pr.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          latest="${{ steps.version.outputs.current }}"
          next="${{ steps.version.outputs.next }}"

          # Generate commit list
          commits=$(git log origin/production..origin/main --pretty=format:"- %s (%h)" 2>/dev/null || echo "- Initial release")

          gh pr create \
            --base production \
            --head main \
            --title "Release ${next}" \
            --label "release" \
            --body "$(cat <<EOF
          ## Release ${next}

          This PR merges \`main\` into \`production\` to create a new release.

          ### Changes since ${latest}

          ${commits}

          ### Pre-merge checklist

          - [ ] All CI checks pass
          - [ ] Changes have been tested on staging/preview
          - [ ] No breaking changes (or documented if any)
          - [ ] Version bump type is correct: \`${{ inputs.version_bump }}\`

          ### Post-merge

          After merging, the [Release workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/release.yml) will automatically:
          1. Create a git tag \`${next}\`
          2. Generate a GitHub release with changelog
          3. Vercel will deploy to production
          EOF
          )"

      - name: Summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.check_pr.outputs.exists }}" = "true" ]; then
            echo "## Release PR Already Exists" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A release PR already exists: #${{ steps.check_pr.outputs.number }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View it: ${{ github.server_url }}/${{ github.repository }}/pull/${{ steps.check_pr.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Release PR Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created to merge \`main\` into \`production\`." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Planned Version:** ${{ steps.version.outputs.next }}" >> $GITHUB_STEP_SUMMARY
            echo "**Version Bump:** ${{ inputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            pr_url=$(gh pr list --base production --head main --json url --jq '.[0].url')
            echo "View it: ${pr_url}" >> $GITHUB_STEP_SUMMARY
          fi
