name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type for this release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          # Get latest tag
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          version="${latest_tag#v}"

          IFS='.' read -r major minor patch <<< "$version"

          case "${{ inputs.version_bump }}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          new_version="v${major}.${minor}.${patch}"
          echo "current=$latest_tag" >> $GITHUB_OUTPUT
          echo "next=$new_version" >> $GITHUB_OUTPUT

      - name: Generate release info
        run: |
          latest="${{ steps.version.outputs.current }}"
          next="${{ steps.version.outputs.next }}"

          echo "## Release $next" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes since $latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          git log origin/production..origin/main --pretty=format:"- %s (%h)" >> $GITHUB_STEP_SUMMARY || echo "- Initial release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Create the PR manually" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run this command locally:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "gh pr create --base production --head main --title \"Release $next\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Or [create it on GitHub](https://github.com/${{ github.repository }}/compare/production...main?expand=1&title=Release%20$next)" >> $GITHUB_STEP_SUMMARY
